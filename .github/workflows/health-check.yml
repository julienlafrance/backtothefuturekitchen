name: Health Check - Monitoring

on:
  schedule:
    - cron: '0 * * * *'  # Toutes les heures √† la minute 0
  workflow_dispatch:  # Permet d√©clenchement manuel

jobs:
  health-check:
    name: Check PREPROD & PROD Health
    runs-on: self-hosted

    steps:
      - name: Check PREPROD health
        id: preprod
        run: |
          echo "üîç Test PREPROD: https://mangetamain.lafrance.io/"

          if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
            if curl -s https://mangetamain.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
              echo "‚úÖ PREPROD OK"
              echo "status=ok" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è PREPROD r√©pond mais contenu inattendu"
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå PREPROD DOWN"
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Check PROD health
        id: prod
        run: |
          echo "üîç Test PROD: https://backtothefuturekitchen.lafrance.io/"

          if curl -f -s --max-time 10 https://backtothefuturekitchen.lafrance.io/ > /dev/null; then
            if curl -s https://backtothefuturekitchen.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
              echo "‚úÖ PROD OK"
              echo "status=ok" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è PROD r√©pond mais contenu inattendu"
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå PROD DOWN"
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Notify if PREPROD is down
        if: steps.preprod.outputs.status != 'ok'
        env:
          PREPROD_STATUS: ${{ steps.preprod.outputs.status }}
        run: |
          if [ "$PREPROD_STATUS" = "down" ]; then
            MESSAGE="üö® **ALERTE - PREPROD DOWN**\n‚ùå Site non accessible: https://mangetamain.lafrance.io/\nüïê $(date +'%Y-%m-%d %H:%M:%S')\n\n**Actions recommand√©es:**\n1. V√©rifier container: \`docker ps | grep mange_preprod\`\n2. Voir logs: \`docker logs mange_preprod --tail=50\`\n3. Red√©marrer si n√©cessaire"
          else
            MESSAGE="‚ö†Ô∏è **WARNING - PREPROD**\n‚ö†Ô∏è Site r√©pond mais contenu inattendu\nüåê URL: https://mangetamain.lafrance.io/\nüïê $(date +'%Y-%m-%d %H:%M:%S')"
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"$MESSAGE\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify if PROD is down
        if: steps.prod.outputs.status != 'ok'
        env:
          PROD_STATUS: ${{ steps.prod.outputs.status }}
        run: |
          if [ "$PROD_STATUS" = "down" ]; then
            MESSAGE="üö® **ALERTE CRITIQUE - PRODUCTION DOWN**\n‚ùå Site non accessible: https://backtothefuturekitchen.lafrance.io/\nüïê $(date +'%Y-%m-%d %H:%M:%S')\n\n**INTERVENTION URGENTE REQUISE:**\n1. V√©rifier container: \`docker ps | grep mange_prod\`\n2. Voir logs: \`docker logs mange_prod --tail=50\`\n3. Red√©marrer: \`cd ~/mangetamain/30_docker && docker-compose -f docker-compose-prod.yml restart\`\n\n@everyone"
          else
            MESSAGE="‚ö†Ô∏è **WARNING - PRODUCTION**\n‚ö†Ô∏è Site r√©pond mais contenu inattendu\nüåê URL: https://backtothefuturekitchen.lafrance.io/\nüïê $(date +'%Y-%m-%d %H:%M:%S')\n\n@everyone"
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"$MESSAGE\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Summary
        run: |
          echo "üìä Health Check Summary"
          echo "PREPROD: ${{ steps.preprod.outputs.status }}"
          echo "PROD: ${{ steps.prod.outputs.status }}"

          if [ "${{ steps.preprod.outputs.status }}" = "ok" ] && [ "${{ steps.prod.outputs.status }}" = "ok" ]; then
            echo "‚úÖ Tous les services sont op√©rationnels"
          else
            echo "‚ö†Ô∏è Au moins un service a un probl√®me"
            exit 1
          fi
