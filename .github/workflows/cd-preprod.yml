name: CD - Preprod Immediate Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permet dÃ©clenchement manuel

env:
  APP_PATH: /home/dataia25/mangetamain/10_preprod
  DOCKER_PATH: /home/dataia25/mangetamain/30_docker
  STATE_FILE: /var/app-state/last-validated-sha.txt

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : Deploy immÃ©diat (sans attendre les tests)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  a-immediate-deploy:
    name: ğŸš€ Deploy Preprod (Immediate)
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir l'historique git

      - name: ğŸ’¾ Save rollback point (SHA actuel AVANT deploy)
        id: save-rollback
        run: |
          cd ${{ env.APP_PATH }}

          # Si le fichier STATE existe, c'est le dernier SHA validÃ©
          if [ -f ${{ env.STATE_FILE }} ]; then
            ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})
            echo "âœ… Rollback point trouvÃ©: $ROLLBACK_SHA"
          else
            # Premier deploy, utiliser le SHA actuel
            ROLLBACK_SHA=$(git rev-parse HEAD)
            echo "ğŸ“ Premier deploy, rollback point: $ROLLBACK_SHA"
            echo "$ROLLBACK_SHA" > ${{ env.STATE_FILE }}
          fi

          echo "rollback_sha=$ROLLBACK_SHA" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Display deployment info
        run: |
          cd ${{ env.APP_PATH }}
          ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Commits to deploy:"
          git log --oneline $ROLLBACK_SHA..${{ github.sha }} || echo "Nouveau commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¬ Notify deployment start
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš€ **DÃ©ploiement Preprod IMMÃ‰DIAT dÃ©marrÃ©**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ Message: ${COMMIT_MSG_FIRST_LINE}\nğŸ‘¤ Par: ${{ github.actor }}\nâš¡ Deploy d'abord, tests CI en parallÃ¨le\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: ğŸš€ Deploy new code
        run: |
          cd ${{ env.APP_PATH }}
          git fetch origin main
          git reset --hard ${{ github.sha }}

          echo "âœ… Code mis Ã  jour vers $(git rev-parse --short HEAD)"

      - name: ğŸ”„ Restart preprod container
        run: |
          cd ${{ env.DOCKER_PATH }}
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ©"

      - name: â³ Wait for container to start
        run: |
          echo "â³ Attente dÃ©marrage Streamlit (60s)..."
          sleep 60

      - name: ğŸ” Health check preprod
        run: |
          echo "ğŸ” Test santÃ© preprod sur https://mangetamain.lafrance.io/"

          # Retry 10 fois avec 10s d'intervalle
          for i in {1..10}; do
            echo "Tentative $i/10..."

            if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
              echo "âœ… Preprod est accessible!"

              # VÃ©rifier que c'est bien Streamlit
              if curl -s https://mangetamain.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
                echo "âœ… Preprod rÃ©pond correctement (contenu Streamlit dÃ©tectÃ©)"
                exit 0
              else
                echo "âš ï¸  Preprod rÃ©pond mais contenu inattendu"
              fi
            else
              echo "âŒ Preprod non accessible, attente 10s..."
              sleep 10
            fi
          done

          echo "âŒ Preprod health check Ã©chouÃ© aprÃ¨s 10 tentatives"
          exit 1

      - name: âœ… Notify deployment success
        if: success()
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement Preprod rÃ©ussi!**\nğŸŒ URL: https://mangetamain.lafrance.io/\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâ³ Tests CI en cours en parallÃ¨le...\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: âŒ Notify deployment failure
        if: failure()
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âŒ **Ã‰CHEC DÃ©ploiement Preprod**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâš ï¸  **Health check Ã©chouÃ© - intervention requise**\nğŸ“‹ VÃ©rifier les logs: \`docker-compose -f docker-compose-preprod.yml logs\`\nğŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : Watcher CI + Rollback automatique
  # PAS de "needs" = s'exÃ©cute EN PARALLÃˆLE du deploy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  b-watch-ci-and-rollback:
    name: ğŸ‘€ Watch CI & Auto-Rollback
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â³ Wait for CI pipeline to complete
        id: wait-ci
        timeout-minutes: 5  # CI ne devrait pas prendre plus de 5min
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "â³ Attente de la fin du CI Pipeline pour commit ${{ github.sha }}..."

          # Attendre que le CI dÃ©marre (30s)
          echo "Attente dÃ©marrage CI (30s)..."
          sleep 30

          # Workflow CI Ã  surveiller
          WORKFLOW_NAME="CI Pipeline - Quality & Tests"

          # Attendre max 4min30 (270s = 27 Ã— 10s)
          for i in {1..27}; do
            # RÃ©cupÃ©rer tous les workflows CI rÃ©cents et filtrer par SHA
            CI_STATUS=$(gh run list \
              --workflow="$WORKFLOW_NAME" \
              --limit 10 \
              --json conclusion,headSha,status \
              --jq ".[] | select(.headSha == \"${{ github.sha }}\") | .conclusion" \
              2>/dev/null | head -1)

            echo "Tentative $i/27 - CI Status pour ${{ github.sha }}: ${CI_STATUS:-pending}"

            if [ "$CI_STATUS" = "success" ]; then
              echo "âœ… CI a rÃ©ussi!"
              echo "ci_conclusion=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$CI_STATUS" = "failure" ]; then
              echo "âŒ CI a Ã©chouÃ©!"
              echo "ci_conclusion=failure" >> $GITHUB_OUTPUT
              exit 1
            elif [ "$CI_STATUS" = "cancelled" ]; then
              echo "ğŸš« CI annulÃ©!"
              echo "ci_conclusion=cancelled" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "CI en cours ou pas encore dÃ©marrÃ©..."
              sleep 10
            fi
          done

          echo "â±ï¸  Timeout CI (5min) - considÃ©rÃ© comme Ã©chec"
          echo "ci_conclusion=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: âœ… Mark deployment as validated
        if: success()
        run: |
          # Le CI a rÃ©ussi, on peut marquer ce SHA comme validÃ©
          echo "${{ github.sha }}" > ${{ env.STATE_FILE }}
          echo "âœ… Deployment validated - new rollback point: ${{ github.sha }}"
          echo "[$(date)] VALIDATED: ${{ github.sha }}" >> /var/log/preprod-deployments.log

      - name: ğŸ”„ ROLLBACK - CI Failed!
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ CI FAILED - Starting automatic rollback"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Lire le SHA de rollback sauvegardÃ©
          ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})

          echo "ğŸ”„ Rolling back to: $ROLLBACK_SHA"
          echo "ğŸ“ Failed SHA was: ${{ github.sha }}"

          cd ${{ env.APP_PATH }}
          git fetch origin
          git reset --hard $ROLLBACK_SHA
          echo "âœ… Code restaurÃ© vers $(git rev-parse --short HEAD)"

          # RedÃ©ployer l'ancienne version
          cd ${{ env.DOCKER_PATH }}
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ© avec version prÃ©cÃ©dente"

          # Attendre que le container redÃ©marre
          sleep 60

          # VÃ©rifier que le rollback fonctionne
          if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
            echo "âœ… Rollback rÃ©ussi - preprod opÃ©rationnelle"
            echo "[$(date)] ROLLBACK: ${{ github.sha }} â†’ $ROLLBACK_SHA" >> /var/log/preprod-deployments.log
          else
            echo "âŒ Rollback Ã©chouÃ© - intervention manuelle requise!"
            exit 1
          fi

      - name: âœ… Notify CI success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **CI Pipeline rÃ©ussi pour Preprod**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸŒ https://mangetamain.lafrance.io/\nâœ¨ DÃ©ploiement validÃ© et persistÃ©!\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: ğŸš¨ Notify rollback
        if: failure()
        run: |
          ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})
          CI_CONCLUSION="${{ steps.wait-ci.outputs.ci_conclusion }}"

          REASON="CI a Ã©chouÃ©"
          if [ "$CI_CONCLUSION" = "timeout" ]; then
            REASON="CI timeout (>5min)"
          elif [ "$CI_CONCLUSION" = "cancelled" ]; then
            REASON="CI annulÃ©"
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸ”„ **ROLLBACK Preprod effectuÃ©**\nâŒ Raison: ${REASON}\nğŸ“¦ Commit annulÃ©: \`${{ github.sha }}\`\nâ†©ï¸  RestaurÃ© vers: \`$ROLLBACK_SHA\`\nğŸŒ https://mangetamain.lafrance.io/\nâš ï¸  Corriger les erreurs avant de re-pusher\nğŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Notes importantes :
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Les 2 jobs s'exÃ©cutent EN PARALLÃˆLE (pas de needs)
# 2. Le rollback point est sauvegardÃ© AVANT le deploy
# 3. Fonctionne avec 1 ou plusieurs commits
# 4. Si CI Ã©choue, rollback automatique au dernier SHA validÃ©
# 5. Le fichier STATE_FILE persiste entre les workflows
#
# PrÃ©requis sur le serveur self-hosted :
# - CrÃ©er le dossier : sudo mkdir -p /var/app-state
# - Permissions : sudo chown dataia25:dataia25 /var/app-state
# - CrÃ©er log : sudo touch /var/log/preprod-deployments.log
# - Permissions log : sudo chown dataia25:dataia25 /var/log/preprod-deployments.log
