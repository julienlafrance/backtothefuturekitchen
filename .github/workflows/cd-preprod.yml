name: CD - Preprod Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline - Quality & Tests"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:  # Permet dÃ©clenchement manuel

jobs:
  deploy-preprod:
    name: Deploy to Preprod
    runs-on: self-hosted
    # Ne dÃ©ployer que si le CI a rÃ©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Notify deployment start
        env:
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
        run: |
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš€ **DÃ©ploiement Preprod dÃ©marrÃ©**\nğŸ“¦ Commit: \`${{ github.event.workflow_run.head_sha }}\`\nğŸ’¬ Message: ${COMMIT_MSG_FIRST_LINE}\nğŸ‘¤ Par: ${{ github.event.workflow_run.head_commit.author.name }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Pull latest code
        run: |
          cd /home/dataia25/mangetamain/10_preprod
          git fetch origin
          git reset --hard origin/main
          echo "âœ… Code mis Ã  jour vers $(git rev-parse --short HEAD)"

      - name: Restart preprod container
        run: |
          cd /home/dataia25/mangetamain/30_docker
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ©"

      - name: Wait for container to start
        run: |
          echo "â³ Attente dÃ©marrage Streamlit (60s)..."
          sleep 60

      - name: Health check preprod
        run: |
          echo "ğŸ” Test santÃ© preprod sur https://mangetamain.lafrance.io/"

          # Retry 10 fois avec 10s d'intervalle
          for i in {1..10}; do
            echo "Tentative $i/10..."

            if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
              echo "âœ… Preprod est accessible!"

              # VÃ©rifier que c'est bien Streamlit
              if curl -s https://mangetamain.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
                echo "âœ… Preprod rÃ©pond correctement (contenu Streamlit dÃ©tectÃ©)"
                exit 0
              else
                echo "âš ï¸  Preprod rÃ©pond mais contenu inattendu"
              fi
            else
              echo "âŒ Preprod non accessible, attente 10s..."
              sleep 10
            fi
          done

          echo "âŒ Preprod health check Ã©chouÃ© aprÃ¨s 10 tentatives"
          exit 1

      - name: Notify deployment success
        if: success()
        env:
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
        run: |
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement Preprod rÃ©ussi!**\nğŸŒ URL: https://mangetamain.lafrance.io/\nğŸ“¦ Commit: \`${{ github.event.workflow_run.head_sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify deployment failure
        if: failure()
        env:
          COMMIT_MSG: ${{ github.event.workflow_run.head_commit.message }}
        run: |
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âŒ **Ã‰CHEC DÃ©ploiement Preprod**\nğŸ“¦ Commit: \`${{ github.event.workflow_run.head_sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâš ï¸  **Container dans Ã©tat cassÃ© - intervention manuelle requise**\nğŸ“‹ VÃ©rifier les logs: \`docker-compose -f docker-compose-preprod.yml logs\`\nğŸ‘¤ Commit par: ${{ github.event.workflow_run.head_commit.author.name }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

  notify-ci-failure:
    name: Notify CI Failure
    runs-on: self-hosted
    # Ne notifier que si le CI a Ã©chouÃ©
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Notify CI failure blocks deployment
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"â›” **DÃ©ploiement Preprod annulÃ©**\nâŒ Le CI Pipeline a Ã©chouÃ© - dÃ©ploiement bloquÃ©\nğŸ“¦ Commit: \`${{ github.event.workflow_run.head_sha }}\`\nğŸ”§ Corriger les erreurs CI avant de dÃ©ployer\nğŸ‘¤ Commit par: ${{ github.event.workflow_run.head_commit.author.name }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
