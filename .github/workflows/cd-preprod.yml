name: CD - Preprod avec Auto-Rollback (Single Job)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_PATH: /home/dataia25/mangetamain/10_preprod
  DOCKER_PATH: /home/dataia25/mangetamain/30_docker
  STATE_FILE: /var/app-state/last-validated-sha.txt

jobs:
  deploy-and-watch:
    name: ğŸš€ Deploy + Watch CI
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ Save rollback point
        run: |
          cd ${{ env.APP_PATH }}
          if [ -f ${{ env.STATE_FILE }} ]; then
            ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})
            echo "âœ… Rollback point: $ROLLBACK_SHA"
          else
            ROLLBACK_SHA=$(git rev-parse HEAD)
            echo "$ROLLBACK_SHA" > ${{ env.STATE_FILE }}
            echo "ğŸ“ Premier deploy, rollback point: $ROLLBACK_SHA"
          fi

      - name: ğŸ“¬ Notify deployment start
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš€ **DÃ©ploiement Preprod dÃ©marrÃ©**\\nğŸ“¦ Commit: \\\`${{ github.sha }}\\\`\\nğŸ’¬ ${COMMIT_MSG}\\nğŸ‘¤ Par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: ğŸš€ Deploy IMMEDIATELY
        run: |
          cd ${{ env.APP_PATH }}
          git fetch origin main
          git reset --hard ${{ github.sha }}
          echo "âœ… Code mis Ã  jour vers $(git rev-parse --short HEAD)"

          cd ${{ env.DOCKER_PATH }}
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ©"

      - name: ğŸ” Quick health check
        run: |
          echo "â³ Attente 30s..."
          sleep 30

          for i in {1..3}; do
            if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
              echo "âœ… Preprod accessible!"
              exit 0
            fi
            echo "Tentative $i/3..."
            sleep 10
          done

          echo "âš ï¸  Preprod lente Ã  dÃ©marrer, mais on continue..."
          exit 0

      - name: ğŸ‘€ Launch CI watcher in background
        run: |
          # CrÃ©er le script de surveillance
          cat > /tmp/watch-ci-${{ github.sha }}.sh << 'SCRIPT_EOF'
          #!/bin/bash
          # Ne PAS utiliser set -e pour Ã©viter crash sur erreurs temporaires

          COMMIT_SHA="${{ github.sha }}"
          APP_PATH="${{ env.APP_PATH }}"
          DOCKER_PATH="${{ env.DOCKER_PATH }}"
          STATE_FILE="${{ env.STATE_FILE }}"
          DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_URL }}"

          echo "[$(date)] ğŸ‘€ Starting CI watch for $COMMIT_SHA"

          # Attendre dÃ©marrage CI (30s)
          sleep 30

          # Attendre max 5 minutes (300s = 30 Ã— 10s)
          for i in {1..30}; do
            CI_STATUS=$(gh run list \
              --workflow="CI Pipeline - Quality & Tests" \
              --limit 10 \
              --json conclusion,headSha \
              --jq ".[] | select(.headSha == \"$COMMIT_SHA\") | .conclusion" \
              2>/dev/null | head -1)

            echo "[$(date)] Tentative $i/30 - CI Status: ${CI_STATUS:-pending}"

            if [ "$CI_STATUS" = "success" ]; then
              echo "[$(date)] âœ… CI passed! Marking as validated"
              echo "$COMMIT_SHA" > $STATE_FILE
              echo "[$(date)] VALIDATED: $COMMIT_SHA" >> /var/log/preprod-deployments.log

              # Notification Discord
              curl -H "Content-Type: application/json" \
                -d "{\"content\":\"âœ… **CI Pipeline rÃ©ussi pour Preprod**\\nğŸ“¦ Commit: \\\`$COMMIT_SHA\\\`\\nğŸŒ https://mangetamain.lafrance.io/\\nâœ¨ DÃ©ploiement validÃ© et persistÃ©!\"}" \
                "$DISCORD_WEBHOOK"

              exit 0
            elif [ "$CI_STATUS" = "failure" ] || [ "$CI_STATUS" = "cancelled" ]; then
              echo "[$(date)] âŒ CI FAILED! Starting rollback..."

              ROLLBACK_SHA=$(cat $STATE_FILE)
              echo "[$(date)] ğŸ”„ Rolling back from $COMMIT_SHA to $ROLLBACK_SHA"

              cd $APP_PATH
              git fetch origin
              git reset --hard $ROLLBACK_SHA
              echo "[$(date)] âœ… Code restaurÃ© vers $(git rev-parse --short HEAD)"

              cd $DOCKER_PATH
              docker-compose -f docker-compose-preprod.yml restart
              echo "[$(date)] âœ… Container redÃ©marrÃ© avec version prÃ©cÃ©dente"

              sleep 60

              if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
                echo "[$(date)] âœ… Rollback rÃ©ussi"
                echo "[$(date)] ROLLBACK: $COMMIT_SHA â†’ $ROLLBACK_SHA" >> /var/log/preprod-deployments.log
              else
                echo "[$(date)] âŒ Rollback Ã©chouÃ©!"
              fi

              # Notification Discord
              curl -H "Content-Type: application/json" \
                -d "{\"content\":\"ğŸ”„ **ROLLBACK Preprod effectuÃ©**\\nâŒ Raison: CI a Ã©chouÃ©\\nğŸ“¦ Commit annulÃ©: \\\`$COMMIT_SHA\\\`\\nâ†©ï¸  RestaurÃ© vers: \\\`$ROLLBACK_SHA\\\`\\nğŸŒ https://mangetamain.lafrance.io/\"}" \
                "$DISCORD_WEBHOOK"

              exit 1
            fi

            sleep 10
          done

          echo "[$(date)] â±ï¸ Timeout CI (5min)"
          echo "[$(date)] TIMEOUT: $COMMIT_SHA" >> /var/log/preprod-deployments.log
          exit 1
          SCRIPT_EOF

          chmod +x /tmp/watch-ci-${{ github.sha }}.sh

          # Lancer en background avec stdbuf pour forcer line buffering
          nohup stdbuf -oL -eL /tmp/watch-ci-${{ github.sha }}.sh \
            > /tmp/ci-watcher-${{ github.sha }}.log 2>&1 &

          WATCHER_PID=$!
          echo "âœ… CI watcher launched in background (PID: $WATCHER_PID)"
          echo "ğŸ“ Logs: /tmp/ci-watcher-${{ github.sha }}.log"
          echo "$WATCHER_PID" > /tmp/watcher-pid-${{ github.sha }}

      - name: âœ… Notify deployment complete
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement Preprod terminÃ©!**\\nğŸŒ URL: https://mangetamain.lafrance.io/\\nğŸ“¦ Commit: \\\`${{ github.sha }}\\\`\\nâ³ CI en cours, rollback auto si Ã©chec\\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: âŒ Notify deployment failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âŒ **Ã‰CHEC DÃ©ploiement Preprod**\\nğŸ“¦ Commit: \\\`${{ github.sha }}\\\`\\nâš ï¸  **Deploy Ã©chouÃ© - intervention requise**\\nğŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Comment Ã§a marche :
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Job dÃ©marre sur self-hosted runner
# 2. Deploy IMMÃ‰DIAT (30-40 secondes)
# 3. Lance script de surveillance en background
# 4. Job se TERMINE â†’ runner LIBÃ‰RÃ‰ immÃ©diatement
# 5. Script background continue de tourner sur le serveur
# 6. Si CI Ã©choue â†’ script fait le rollback automatique
# 7. Script se termine et nettoie
#
# Avantages :
# âœ… Runner libÃ©rÃ© immÃ©diatement aprÃ¨s deploy
# âœ… Pas de blocage pour les prochains workflows
# âœ… Le watch tourne en arriÃ¨re-plan sur le serveur
# âœ… Un seul job = pas de problÃ¨me d'ordre d'exÃ©cution
# âœ… STATE_FILE persiste entre les workflows
