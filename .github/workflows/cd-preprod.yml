name: CD - Preprod Immediate Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permet dÃ©clenchement manuel

jobs:
  immediate-deploy:
    name: Deploy to Preprod (Immediate)
    runs-on: self-hosted

    outputs:
      previous_sha: ${{ steps.save-state.outputs.previous_sha }}
      new_sha: ${{ steps.save-state.outputs.new_sha }}

    steps:
      - name: Save current state for potential rollback
        id: save-state
        run: |
          cd /home/dataia25/mangetamain/10_preprod
          PREVIOUS_SHA=$(git rev-parse HEAD)
          echo "previous_sha=$PREVIOUS_SHA" >> $GITHUB_OUTPUT
          echo "new_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ğŸ“¸ Ã‰tat sauvegardÃ©: $PREVIOUS_SHA (pour rollback si besoin)"

      - name: Notify deployment start
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš€ **DÃ©ploiement Preprod IMMÃ‰DIAT dÃ©marrÃ©**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ Message: ${COMMIT_MSG_FIRST_LINE}\nğŸ‘¤ Par: ${{ github.actor }}\nâš¡ Deploy d'abord, tests en parallÃ¨le\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Pull latest code
        run: |
          cd /home/dataia25/mangetamain/10_preprod
          git fetch origin
          git reset --hard origin/main
          echo "âœ… Code mis Ã  jour vers $(git rev-parse --short HEAD)"

      - name: Restart preprod container
        run: |
          cd /home/dataia25/mangetamain/30_docker
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ©"

      - name: Wait for container to start
        run: |
          echo "â³ Attente dÃ©marrage Streamlit (60s)..."
          sleep 60

      - name: Health check preprod
        run: |
          echo "ğŸ” Test santÃ© preprod sur https://mangetamain.lafrance.io/"

          # Retry 10 fois avec 10s d'intervalle
          for i in {1..10}; do
            echo "Tentative $i/10..."

            if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
              echo "âœ… Preprod est accessible!"

              # VÃ©rifier que c'est bien Streamlit
              if curl -s https://mangetamain.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
                echo "âœ… Preprod rÃ©pond correctement (contenu Streamlit dÃ©tectÃ©)"
                exit 0
              else
                echo "âš ï¸  Preprod rÃ©pond mais contenu inattendu"
              fi
            else
              echo "âŒ Preprod non accessible, attente 10s..."
              sleep 10
            fi
          done

          echo "âŒ Preprod health check Ã©chouÃ© aprÃ¨s 10 tentatives"
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement Preprod rÃ©ussi!**\nğŸŒ URL: https://mangetamain.lafrance.io/\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâ³ Tests CI en cours...\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          COMMIT_MSG_FIRST_LINE=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âŒ **Ã‰CHEC DÃ©ploiement Preprod**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâš ï¸  **Container dans Ã©tat cassÃ© - rollback manuel requis**\nğŸ“‹ VÃ©rifier les logs: \`docker-compose -f docker-compose-preprod.yml logs\`\nğŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

  watch-ci-and-rollback:
    name: Watch CI & Rollback if Failed
    runs-on: self-hosted
    needs: immediate-deploy
    if: always()  # Toujours exÃ©cuter pour surveiller le CI

    steps:
      - name: Wait for CI completion
        id: wait-ci
        run: |
          echo "â³ Attente de la fin du CI Pipeline..."

          # Attendre max 5 minutes que le CI dÃ©marre
          echo "Attente dÃ©marrage CI..."
          sleep 30

          # Attendre que le CI se termine (max 10 minutes)
          for i in {1..60}; do
            # RÃ©cupÃ©rer le statut du dernier workflow CI pour ce commit
            CI_STATUS=$(gh run list \
              --workflow="CI Pipeline - Quality & Tests" \
              --commit "${{ github.sha }}" \
              --json conclusion \
              --jq '.[0].conclusion' \
              2>/dev/null || echo "pending")

            echo "Tentative $i/60 - CI Status: $CI_STATUS"

            if [ "$CI_STATUS" = "success" ]; then
              echo "âœ… CI a rÃ©ussi!"
              echo "ci_result=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$CI_STATUS" = "failure" ]; then
              echo "âŒ CI a Ã©chouÃ©!"
              echo "ci_result=failure" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$CI_STATUS" = "null" ] || [ "$CI_STATUS" = "pending" ] || [ "$CI_STATUS" = "" ]; then
              echo "CI en cours..."
              sleep 10
            else
              echo "âš ï¸  CI status inattendu: $CI_STATUS"
              sleep 10
            fi
          done

          echo "â±ï¸  Timeout CI (10min) - considÃ©rÃ© comme Ã©chec"
          echo "ci_result=timeout" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Rollback if CI failed
        if: steps.wait-ci.outputs.ci_result == 'failure' || steps.wait-ci.outputs.ci_result == 'timeout'
        run: |
          echo "ğŸ”„ ROLLBACK en cours vers ${{ needs.immediate-deploy.outputs.previous_sha }}..."

          cd /home/dataia25/mangetamain/10_preprod
          git fetch origin
          git reset --hard ${{ needs.immediate-deploy.outputs.previous_sha }}
          echo "âœ… Code restaurÃ© vers $(git rev-parse --short HEAD)"

          cd /home/dataia25/mangetamain/30_docker
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ© avec version prÃ©cÃ©dente"

          sleep 60

          # VÃ©rifier que le rollback fonctionne
          if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
            echo "âœ… Rollback rÃ©ussi - preprod opÃ©rationnelle"
          else
            echo "âŒ Rollback Ã©chouÃ© - intervention manuelle requise!"
            exit 1
          fi

      - name: Notify CI success
        if: steps.wait-ci.outputs.ci_result == 'success'
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **CI Pipeline rÃ©ussi pour Preprod**\nğŸ“¦ Commit: \`${{ github.sha }}\`\nğŸŒ https://mangetamain.lafrance.io/\nâœ¨ DÃ©ploiement validÃ©!\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify rollback
        if: steps.wait-ci.outputs.ci_result == 'failure' || steps.wait-ci.outputs.ci_result == 'timeout'
        run: |
          REASON="CI a Ã©chouÃ©"
          if [ "${{ steps.wait-ci.outputs.ci_result }}" = "timeout" ]; then
            REASON="CI timeout (>10min)"
          fi

          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸ”„ **ROLLBACK Preprod effectuÃ©**\nâŒ Raison: ${REASON}\nğŸ“¦ Commit annulÃ©: \`${{ github.sha }}\`\nâ†©ï¸  RestaurÃ© vers: \`${{ needs.immediate-deploy.outputs.previous_sha }}\`\nğŸŒ https://mangetamain.lafrance.io/\nâš ï¸  Corriger les erreurs avant de re-pusher\nğŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
