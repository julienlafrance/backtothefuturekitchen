name: CD - Preprod avec Auto-Rollback (Single Job)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_PATH: /home/dataia25/mangetamain/10_preprod
  DOCKER_PATH: /home/dataia25/mangetamain/30_docker
  STATE_FILE: /var/app-state/last-validated-sha.txt

jobs:
  deploy-and-watch:
    name: ðŸš€ Deploy + Watch CI
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ’¾ Save rollback point
        run: |
          cd ${{ env.APP_PATH }}
          if [ -f ${{ env.STATE_FILE }} ]; then
            ROLLBACK_SHA=$(cat ${{ env.STATE_FILE }})
            echo "âœ… Rollback point: $ROLLBACK_SHA"
          else
            ROLLBACK_SHA=$(git rev-parse HEAD)
            echo "$ROLLBACK_SHA" > ${{ env.STATE_FILE }}
            echo "ðŸ“ Premier deploy, rollback point: $ROLLBACK_SHA"
          fi

      - name: ðŸ“¬ Notify deployment start
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B ${{ github.sha }} | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸš€ **DÃ©ploiement Preprod dÃ©marrÃ©**\nðŸ“¦ Commit: \`${{ github.sha }}\`\nðŸ’¬ ${COMMIT_MSG}\nðŸ‘¤ Par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: ðŸš€ Deploy IMMEDIATELY
        run: |
          cd ${{ env.APP_PATH }}
          echo "ðŸ“¥ Fetching latest commits from origin/main..."
          git fetch origin main
          echo "ðŸ”„ Resetting to ${{ github.sha }}..."
          git reset --hard ${{ github.sha }}
          echo "âœ… Code mis Ã  jour vers $(git rev-parse --short HEAD)"

          cd ${{ env.DOCKER_PATH }}
          docker-compose -f docker-compose-preprod.yml restart
          echo "âœ… Container preprod redÃ©marrÃ©"

      - name: ðŸ” Quick health check
        run: |
          echo "â³ Attente 30s..."
          sleep 30

          for i in {1..3}; do
            if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
              echo "âœ… Preprod accessible!"
              exit 0
            fi
            echo "Tentative $i/3..."
            sleep 10
          done

          echo "âš ï¸  Preprod lente Ã  dÃ©marrer, mais on continue..."
          exit 0

      - name: ðŸ‘€ Launch CI watcher in background
        run: |
          # CrÃ©er le script de surveillance
          cat > /tmp/watch-ci-${{ github.sha }}.sh << 'SCRIPT_EOF'
          #!/bin/bash
          # Ne PAS utiliser set -e pour Ã©viter crash sur erreurs temporaires

          COMMIT_SHA="${{ github.sha }}"
          APP_PATH="${{ env.APP_PATH }}"
          DOCKER_PATH="${{ env.DOCKER_PATH }}"
          STATE_FILE="${{ env.STATE_FILE }}"
          DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_URL }}"
          LOG_FILE="/tmp/ci-watcher-${COMMIT_SHA}.log"

          echo "[$(date)] ðŸ‘€ Starting CI watch for $COMMIT_SHA" >> "$LOG_FILE"

          # Se placer dans le rÃ©pertoire du repo pour que gh fonctionne
          cd $APP_PATH

          # Attendre dÃ©marrage CI (30s)
          echo "[$(date)] â³ Waiting 30s for CI to start..." >> "$LOG_FILE"
          sleep 30

          # Attendre max 5 minutes (300s = 30 Ã— 10s)
          for i in {1..30}; do
            CI_STATUS=$(gh run list \
              --workflow="CI Pipeline - Quality & Tests" \
              --limit 10 \
              --json conclusion,headSha \
              --jq ".[] | select(.headSha == \"$COMMIT_SHA\") | .conclusion" \
              2>/dev/null | head -1)

            echo "[$(date)] Tentative $i/30 - CI Status: ${CI_STATUS:-pending}" >> "$LOG_FILE"

            if [ "$CI_STATUS" = "success" ]; then
              echo "[$(date)] âœ… CI passed! Marking as validated" >> "$LOG_FILE"
              echo "$COMMIT_SHA" > $STATE_FILE

              # Notification Discord
              curl -H "Content-Type: application/json" \
                -d "{\"content\":\"âœ… **CI Pipeline rÃ©ussi pour Preprod**\nðŸ“¦ Commit: \`$COMMIT_SHA\`\nðŸŒ https://mangetamain.lafrance.io/\nâœ¨ DÃ©ploiement validÃ© et persistÃ©!\"}" \
                "$DISCORD_WEBHOOK"

              exit 0
            elif [ "$CI_STATUS" = "failure" ] || [ "$CI_STATUS" = "cancelled" ]; then
              echo "[$(date)] âŒ CI FAILED! Starting rollback..." >> "$LOG_FILE"

              ROLLBACK_SHA=$(cat $STATE_FILE)
              echo "[$(date)] ðŸ”„ Rolling back from $COMMIT_SHA to $ROLLBACK_SHA" >> "$LOG_FILE"

              cd $APP_PATH
              git fetch origin
              git reset --hard $ROLLBACK_SHA
              echo "[$(date)] âœ… Code restaurÃ© vers $(git rev-parse --short HEAD)" >> "$LOG_FILE"

              cd $DOCKER_PATH
              docker-compose -f docker-compose-preprod.yml restart
              echo "[$(date)] âœ… Container redÃ©marrÃ© avec version prÃ©cÃ©dente" >> "$LOG_FILE"

              sleep 60

              if curl -f -s --max-time 10 https://mangetamain.lafrance.io/ > /dev/null; then
                echo "[$(date)] âœ… Rollback rÃ©ussi" >> "$LOG_FILE"
              else
                echo "[$(date)] âŒ Rollback Ã©chouÃ©!" >> "$LOG_FILE"
              fi

              # Notification Discord
              curl -H "Content-Type: application/json" \
                -d "{\"content\":\"ðŸ”„ **ROLLBACK Preprod effectuÃ©**\nâŒ Raison: CI a Ã©chouÃ©\nðŸ“¦ Commit annulÃ©: \`$COMMIT_SHA\`\nâ†©ï¸  RestaurÃ© vers: \`$ROLLBACK_SHA\`\nðŸŒ https://mangetamain.lafrance.io/\"}" \
                "$DISCORD_WEBHOOK"

              exit 1
            fi

            sleep 10
          done

          echo "[$(date)] â±ï¸ Timeout CI (5min)" >> "$LOG_FILE"
          exit 1
          SCRIPT_EOF

          chmod +x /tmp/watch-ci-${{ github.sha }}.sh

          # Lancer en background DETACHE (setsid crÃ©e nouvelle session indÃ©pendante)
          # Cela empÃªche GitHub Actions de tuer le processus Ã  la fin du job
          setsid bash /tmp/watch-ci-${{ github.sha }}.sh > /dev/null 2>&1 < /dev/null &
          disown

          echo "âœ… CI watcher launched in background (detached session)"

      - name: âœ… Notify deployment complete
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement Preprod terminÃ©!**\nðŸŒ URL: https://mangetamain.lafrance.io/\nðŸ“¦ Commit: \`${{ github.sha }}\`\nâ³ CI en cours, rollback auto si Ã©chec\nðŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: âŒ Notify deployment failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âŒ **Ã‰CHEC DÃ©ploiement Preprod**\nðŸ“¦ Commit: \`${{ github.sha }}\`\nâš ï¸  **Deploy Ã©chouÃ© - intervention requise**\nðŸ‘¤ Commit par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Comment Ã§a marche :
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Job dÃ©marre sur self-hosted runner
# 2. Deploy IMMÃ‰DIAT (30-40 secondes)
# 3. Lance script de surveillance en background
# 4. Job se TERMINE â†’ runner LIBÃ‰RÃ‰ immÃ©diatement
# 5. Script background continue de tourner sur le serveur
# 6. Si CI Ã©choue â†’ script fait le rollback automatique
# 7. Script se termine et nettoie
#
# Avantages :
# âœ… Runner libÃ©rÃ© immÃ©diatement aprÃ¨s deploy
# âœ… Pas de blocage pour les prochains workflows
# âœ… Le watch tourne en arriÃ¨re-plan sur le serveur
# âœ… Un seul job = pas de problÃ¨me d'ordre d'exÃ©cution
# âœ… STATE_FILE persiste entre les workflows
