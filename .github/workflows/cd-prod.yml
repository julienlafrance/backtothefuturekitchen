name: CD - Production Deployment

on:
  workflow_dispatch:  # DÃ©clenchement MANUEL uniquement
    inputs:
      confirm:
        description: 'Taper "DEPLOY" pour confirmer le dÃ©ploiement en production'
        required: true
        default: ''

jobs:
  deploy-prod:
    name: Deploy to Production
    runs-on: self-hosted
    # VÃ©rifier que l'utilisateur a bien tapÃ© "DEPLOY"
    if: github.event.inputs.confirm == 'DEPLOY'

    steps:
      - name: Notify deployment start
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš¨ **DÃ©ploiement PRODUCTION dÃ©marrÃ©**\nğŸ“¦ Commit: \`${GITHUB_SHA:0:7}\`\nğŸ’¬ Message: ${COMMIT_MSG_FIRST_LINE}\nğŸ‘¤ Par: ${{ github.actor }}\nâš ï¸  DÃ©ploiement manuel confirmÃ©\n\n**Ã‰tapes:**\n1ï¸âƒ£ Backup PROD actuel\n2ï¸âƒ£ Pull code depuis GitHub\n3ï¸âƒ£ ExÃ©cution deploy_preprod_to_prod.sh\n4ï¸âƒ£ RedÃ©marrage container (down && up)\n5ï¸âƒ£ Health checks (100s)\n\nâ±ï¸ DurÃ©e estimÃ©e: ~3 minutes\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Backup current production files
        run: |
          cd /home/dataia25/mangetamain
          BACKUP_DIR="/home/dataia25/mangetamain/backups/prod/backup-$(date +%Y%m%d_%H%M%S)"
          echo "ğŸ“ CrÃ©ation backup PROD versionnÃ© dans: $BACKUP_DIR"

          mkdir -p "$BACKUP_DIR"

          # Backup complet: streamlit, pyproject.toml, README.md
          cp -r 20_prod/streamlit "$BACKUP_DIR/"
          [ -f 20_prod/pyproject.toml ] && cp 20_prod/pyproject.toml "$BACKUP_DIR/"
          [ -f 20_prod/README.md ] && cp 20_prod/README.md "$BACKUP_DIR/"

          # Sauvegarder le chemin du backup pour rollback
          echo "$BACKUP_DIR" > /tmp/prod-backup-path.txt

          # VÃ©rifier le backup
          BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
          echo "âœ… Backup PROD crÃ©Ã©: $BACKUP_SIZE"
          echo "ğŸ“ Contenu du backup:"
          ls -lh "$BACKUP_DIR/"

          # Lister tous les backups existants
          echo "ğŸ“‚ Backups PROD disponibles:"
          ls -lht /home/dataia25/mangetamain/backups/prod/ | head -5

      - name: Deploy PREPROD to PROD
        run: |
          cd /home/dataia25/mangetamain
          echo "ğŸš€ ExÃ©cution du script de dÃ©ploiement PREPROD â†’ PROD"
          ./70_scripts/deploy_preprod_to_prod.sh
          echo "âœ… Fichiers copiÃ©s de PREPROD vers PROD"

      - name: Restart production container
        run: |
          cd /home/dataia25/mangetamain/30_docker
          echo "ğŸ”„ ArrÃªt du container PROD..."
          docker-compose -f docker-compose-prod.yml down

          echo "ğŸš€ DÃ©marrage du container PROD avec nouveaux mounts..."
          docker-compose -f docker-compose-prod.yml up -d

          echo "âœ… Container production redÃ©marrÃ© (down && up pour nouveaux mounts)"

      - name: Wait for container to start
        run: |
          echo "â³ Attente dÃ©marrage Streamlit production..."
          echo "   - Installation dÃ©pendances (uv sync): ~90s"
          echo "   - DÃ©marrage Streamlit: ~10s"
          sleep 90
          echo "âœ… DÃ©lai d'attente terminÃ©"

      - name: Health check production
        run: |
          echo "ğŸ” Test santÃ© production sur https://backtothefuturekitchen.lafrance.io/"
          echo ""

          # Test Docker container health
          echo "ğŸ³ VÃ©rification statut container Docker..."
          if docker ps --format '{{.Names}}\t{{.Status}}' | grep -q "mange_prod.*healthy"; then
            echo "âœ… Container Docker: healthy"
          else
            echo "âš ï¸  Container Docker pas encore healthy, attente..."
          fi
          echo ""

          # Retry 10 fois avec 10s d'intervalle
          for i in {1..10}; do
            echo "ğŸŒ Test HTTP $i/10..."

            if curl -f -s --max-time 10 https://backtothefuturekitchen.lafrance.io/ > /dev/null; then
              echo "   âœ… Site accessible (HTTP 200)"

              if curl -s https://backtothefuturekitchen.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
                echo "   âœ… Contenu Streamlit dÃ©tectÃ©"
                echo ""
                echo "ğŸ‰ Production dÃ©ployÃ©e avec succÃ¨s!"
                exit 0
              else
                echo "   âš ï¸  RÃ©ponse HTTP mais contenu inattendu"
              fi
            else
              echo "   âŒ Site non accessible"
              if [ $i -lt 10 ]; then
                echo "   â³ Attente 10s avant nouvelle tentative..."
                sleep 10
              fi
            fi
          done

          echo ""
          echo "âŒ Production health check Ã©chouÃ© aprÃ¨s 10 tentatives (100s)"
          exit 1

      - name: Notify deployment success
        if: success()
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          BACKUP_DIR=$(cat /tmp/prod-backup-path.txt 2>/dev/null || echo "inconnu")
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement PRODUCTION rÃ©ussi!**\n\nğŸŒ **URL:** https://backtothefuturekitchen.lafrance.io/\nğŸ“¦ **Commit:** \`${GITHUB_SHA:0:7}\`\nğŸ’¬ **Message:** ${COMMIT_MSG_FIRST_LINE}\n\n**DÃ©tails:**\nâœ… Backup crÃ©Ã©: \`$BACKUP_DIR\`\nâœ… Script deploy_preprod_to_prod.sh exÃ©cutÃ©\nâœ… Container redÃ©marrÃ© (down && up)\nâœ… Health checks passÃ©s\nâœ… DonnÃ©es chargÃ©es depuis S3 Parquet\n\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\nğŸ‘¤ DÃ©ployÃ© par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify deployment failure
        if: failure()
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          BACKUP_DIR=$(cat /tmp/prod-backup-path.txt 2>/dev/null || echo "inconnu")
          COMMIT_MSG_FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš¨ **Ã‰CHEC - DÃ©ploiement PRODUCTION**\nâŒ Health check Ã©chouÃ©\nğŸ“¦ Source: PREPROD â†’ PROD\nğŸ’¬ ${COMMIT_MSG_FIRST_LINE}\nâš ï¸  **PRODUCTION POTENTIELLEMENT CASSÃ‰E**\n\n**Rollback manuel recommandÃ©:**\n\`\`\`bash\nssh dataia\ncd /home/dataia25/mangetamain/20_prod\n\n# Restaurer le backup complet\nrm -rf streamlit pyproject.toml README.md\ncp -r $BACKUP_DIR/streamlit .\ncp $BACKUP_DIR/pyproject.toml .\ncp $BACKUP_DIR/README.md .\n\n# RedÃ©marrer le container\ncd /home/dataia25/mangetamain/30_docker\ndocker-compose -f docker-compose-prod.yml down\ndocker-compose -f docker-compose-prod.yml up -d\n\`\`\`\n\nğŸ“‚ Backup: \`$BACKUP_DIR\`\nğŸŒ VÃ©rifier: https://backtothefuturekitchen.lafrance.io/\nğŸ‘¤ TentÃ© par: ${{ github.actor }}\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

  cancelled:
    name: Deployment Cancelled
    runs-on: self-hosted
    if: github.event.inputs.confirm != 'DEPLOY'

    steps:
      - name: Notify cancellation
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âš ï¸  **DÃ©ploiement PRODUCTION annulÃ©**\nConfirmation incorrecte (attendu: DEPLOY)\nğŸ‘¤ Par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
