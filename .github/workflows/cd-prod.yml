name: CD - Production Deployment

on:
  workflow_dispatch:  # DÃ©clenchement MANUEL uniquement
    inputs:
      confirm:
        description: 'Taper "DEPLOY" pour confirmer le dÃ©ploiement en production'
        required: true
        default: ''

jobs:
  deploy-prod:
    name: Deploy to Production
    runs-on: self-hosted
    # VÃ©rifier que l'utilisateur a bien tapÃ© "DEPLOY"
    if: github.event.inputs.confirm == 'DEPLOY'

    steps:
      - name: Notify deployment start
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš¨ **DÃ©ploiement PRODUCTION dÃ©marrÃ©**\nğŸ“¦ Commit: \`${GITHUB_SHA:0:7}\`\nğŸ’¬ Message: ${COMMIT_MSG}\nğŸ‘¤ Par: ${{ github.actor }}\nâš ï¸  DÃ©ploiement manuel confirmÃ©\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Backup current production version
        run: |
          cd /home/dataia25/mangetamain/20_prod
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“ Version prod actuelle: $CURRENT_COMMIT"
          echo "$CURRENT_COMMIT" > /tmp/prod-backup-commit.txt
          echo "âœ… Backup commit ID sauvegardÃ©"

      - name: Pull latest code
        run: |
          cd /home/dataia25/mangetamain/20_prod
          git fetch origin
          git reset --hard origin/main
          NEW_COMMIT=$(git rev-parse --short HEAD)
          echo "âœ… Code prod mis Ã  jour vers $NEW_COMMIT"

      - name: Restart production container
        run: |
          cd /home/dataia25/mangetamain/30_docker
          docker-compose -f docker-compose-prod.yml restart
          echo "âœ… Container production redÃ©marrÃ©"

      - name: Wait for container to start
        run: |
          echo "â³ Attente dÃ©marrage Streamlit production (60s)..."
          sleep 60

      - name: Health check production
        run: |
          echo "ğŸ” Test santÃ© production sur https://backtothefuturekitchen.lafrance.io/"

          # Retry 10 fois avec 10s d'intervalle
          for i in {1..10}; do
            echo "Tentative $i/10..."

            if curl -f -s --max-time 10 https://backtothefuturekitchen.lafrance.io/ > /dev/null; then
              echo "âœ… Production est accessible!"

              if curl -s https://backtothefuturekitchen.lafrance.io/ | grep -q "Back to the Kitchen\|Streamlit\|streamlit"; then
                echo "âœ… Production rÃ©pond correctement"
                exit 0
              else
                echo "âš ï¸  Production rÃ©pond mais contenu inattendu"
              fi
            else
              echo "âŒ Production non accessible, attente 10s..."
              sleep 10
            fi
          done

          echo "âŒ Production health check Ã©chouÃ© aprÃ¨s 10 tentatives"
          exit 1

      - name: Notify deployment success
        if: success()
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âœ… **DÃ©ploiement PRODUCTION rÃ©ussi!**\nğŸŒ URL: https://backtothefuturekitchen.lafrance.io/\nğŸ“¦ Commit: \`${GITHUB_SHA:0:7}\`\nğŸ’¬ ${COMMIT_MSG}\nğŸ• $(date +'%Y-%m-%d %H:%M:%S')\nğŸ‘¤ DÃ©ployÃ© par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          OLD_COMMIT=$(cat /tmp/prod-backup-commit.txt)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸš¨ **Ã‰CHEC CRITIQUE - DÃ©ploiement PRODUCTION**\nâŒ Health check Ã©chouÃ©\nğŸ“¦ Commit tentÃ©: \`${GITHUB_SHA:0:7}\`\nğŸ’¬ ${COMMIT_MSG}\nğŸ”™ Backup disponible: \`${OLD_COMMIT:0:7}\`\nâš ï¸  **PRODUCTION POTENTIELLEMENT CASSÃ‰E**\nğŸ“‹ Rollback manuel requis:\n\`\`\`\ncd /home/dataia25/mangetamain/20_prod\ngit reset --hard $OLD_COMMIT\ncd ../30_docker\ndocker-compose -f docker-compose-prod.yml restart\n\`\`\`\nğŸ‘¤ TentÃ© par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

  cancelled:
    name: Deployment Cancelled
    runs-on: self-hosted
    if: github.event.inputs.confirm != 'DEPLOY'

    steps:
      - name: Notify cancellation
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"content\":\"âš ï¸  **DÃ©ploiement PRODUCTION annulÃ©**\nConfirmation incorrecte (attendu: DEPLOY)\nğŸ‘¤ Par: ${{ github.actor }}\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
